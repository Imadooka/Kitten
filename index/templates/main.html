{% load static %}
<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      background-color: #f0f8ff;
      color: #37474F;
      margin: 0;
      padding: 0;
    }

    .navbar {
      background-color: #ffffff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #90CAF9;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .navbar-logo {
      font-size: 20px;
      font-weight: 600;
      color: #1976D2;
    }

    .navbar-menu {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    .navbar-menu li a {
      text-decoration: none;
      color: #37474F;
      font-weight: 500;
      transition: color 0.2s;
    }

    .navbar-menu li a:hover {
      color: #0D47A1;
    }

    .confirm-bar.hidden {
      display: none !important;
    }

    .container {
      max-width: 1400px;
      margin: auto;
      padding: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 500px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .card-body {
      padding: 16px;
    }

    .badge {
      border-radius: 8px;
      padding: 4px 8px;
      font-weight: 500;
      display: inline-block;
    }

    .badge-safe {
      background-color: #E8F5E9;
      color: #2E7D32;
    }

    .badge-warning {
      background-color: #FFF8E1;
      color: #F57F17;
    }

    .badge-danger {
      background-color: #FFEBEE;
      color: #C62828;
    }

    /* Modal: ‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ */
    .modal-panel {
      background: #fff;
      width: min(720px, 92vw);
      max-height: 85vh;
      overflow: auto;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
      position: relative;
      padding: 18px 18px 22px;
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    .modal-title {
      margin: 14px 0 10px;
      color: #0f172a;
    }

    .modal-x {
      position: absolute;
      top: 10px;
      left: 10px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      color: #0f172a;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .06);
      z-index: 3;
    }

    .src-btn {
      border: 1px solid #cbd5e1;
      background: #fff;
      color: #0f172a;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .src-btn.is-active {
      background: #1976D2;
      color: #fff;
      border-color: #1976D2;
    }

    .section-title {
      margin: 12px 0 6px;
      font-size: 16px;
      font-weight: 700;
      color: #334155;
    }

    .recipe-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .recipe-item {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #fff;
      padding: 14px 16px;
      margin: 10px 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .05);
    }

    .recipe-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recipe-title {
      font-weight: 700;
      font-size: 15px;
      color: #0f172a;
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .recipe-meta {
      font-size: 13px;
      margin-top: 6px;
      line-height: 1.4;
    }

    .recipe-meta .ok {
      color: #2E7D32;
      font-weight: 600;
    }

    .recipe-meta .miss {
      color: #C62828;
      font-weight: 600;
    }

    .howto-btn {
      background: #1976D2;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
      transition: 0.2s;
    }

    .howto-btn:hover {
      background: #1565C0;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(21, 101, 192, .25);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .modal-backdrop.is-show {
      display: flex;
    }

    /* HOWTO modal */
    #howtoModal .btn {
      border: 1px solid #cbd5e1;
      background: #fff;
      color: #0f172a;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-primary {
      background: #1976D2;
      color: #fff;
      border-color: #1976D2;
    }

    .btn-primary:hover {
      background: #1565C0;
    }

    .hidden {
      display: none;
    }

    .quantity-control,
    .qty-editor {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .qty-step {
      background: #1976D2;
      color: #fff;
      border: none;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
    }

    .qty-step:hover {
      background: #0D47A1;
    }

    .qty-delta {
      min-width: 24px;
      text-align: center;
      font-weight: 700;
    }

    .confirm-bar {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
    }

    .btn {
      min-width: 90px;
      text-align: center;
      padding: 8px 12px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #f1f5f9;
      color: #0f172a;
    }

    .btn:hover {
      background: #e2e8f0;
    }

    .qty-step:disabled {
      opacity: .4;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-logo">KitchenSync</div>
    <ul class="navbar-menu">
      <li><a href="{% url 'add_ingredient' %}">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</a></li>
      <li><a href="{% url 'suggest' %}">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h1>

    <div style="display:flex; align-items:center; gap:10px;">
      <input id="searchBox" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶"
        style="padding:8px 10px;border:1px solid #90CAF9;border-radius:8px;outline:none;">
      <button id="voiceBtn" type="button" aria-pressed="false"
        style="border:none;background:#1976D2;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;">üé§</button>
      <span id="voiceStatus" style="font-size:12px;color:#1976D2;margin-left:8px;"></span>
    </div>

    <div style="margin-bottom: 24px;">
      <div>
        <h2>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <div class="grid" id="ingredientContainer">
          {% for ing in ingredients %}
          <div class="card" data-days="{{ ing.days_remaining }}">
            {% with url=ing.image_url %}
            {% if url %}
            <img src="{{ url }}" alt="{{ ing.name }}" style="cursor:pointer;"
              onclick="openRecipes('{{ ing.name|escapejs }}')">
            {% else %}
            <div
              style="width:100%;height:200px;display:flex;align-items:center;justify-content:center;background:#eee;color:#888;cursor:pointer;"
              onclick="openRecipes('{{ ing.name|escapejs }}')">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </div>
            {% endif %}
            {% endwith %}
            <div class="card-body">
              <h3>{{ ing.name }} (x{{ ing.quantity }})</h3>
              <p>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: {{ ing.expiry_date }}</p>
              <p>
                {% if ing.days_remaining > 5 %}
                <span class="badge badge-safe">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {{ ing.days_remaining }} ‡∏ß‡∏±‡∏ô</span>
                {% elif ing.days_remaining > 2 %}
                <span class="badge badge-warning">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {{ ing.days_remaining }} ‡∏ß‡∏±‡∏ô</span>
                {% elif ing.days_remaining < 1 %} <span class="badge badge-danger">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span>
                  {% else %}
                  <span class="badge badge-danger">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {{ ing.days_remaining }} ‡∏ß‡∏±‡∏ô</span>
                  {% endif %}
              </p>

              <div class="qty-editor" data-iid="{{ ing.id }}" data-iname="{{ ing.name|escapejs }}"
                data-qty="{{ ing.quantity }}">
                <button type="button" class="qty-step" data-step="-1">-</button>
                <span class="qty-delta" id="delta-{{ ing.id }}">0</span>
                <button type="button" class="qty-step" data-step="1">+</button>
              </div>

              <div class="confirm-bar hidden" id="confirm-{{ ing.id }}">
                <button type="button" class="btn btn-cancel" data-iid="{{ ing.id }}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary btn-save" data-iid="{{ ing.id }}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Recipe Modal -->
    <div id="recipeModal" class="modal-backdrop">
      <div class="modal-panel">
        <button class="modal-x" type="button" aria-label="‡∏õ‡∏¥‡∏î" onclick="closeModal()">‚úï</button>
        <div class="modal-header">
          <div class="modal-actions">
            <button id="btnSourceLocal" class="src-btn is-active" data-source="local">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢</button>
            <button id="btnSourceApi" class="src-btn" data-source="api">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</button>
          </div>
        </div>
        <h2 id="recipeTitle" class="modal-title">‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
        <ul id="recipeList" class="recipe-list"></ul>
      </div>
    </div>

    <!-- HOWTO Modal -->
    <div id="howtoModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
         justify-content:center; align-items:center; z-index:10060;">
      <div
        style="background:#fff; width:min(720px,92vw); max-height:85vh; overflow:auto; border-radius:14px; padding:18px;">
        <div
          style="display:flex; align-items:center; justify-content:space-between; gap:8px; border-bottom:1px solid #eee; padding-bottom:8px;">
          <h2 id="howtoTitle" style="margin:0;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥</h2>
          <button type="button" class="btn"
            onclick="document.getElementById('howtoModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
        </div>
        <div id="howtoIngredients" style="margin:8px 0; color:#475569"></div>
        <ol id="howtoSteps" style="padding-left:22px"></ol>
        <div id="howtoLinks" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    function toThaiLower(s) { return (s || '').toLocaleLowerCase('th-TH'); }
    function normalizeThaiDigits(str) {
      if (!str) return '';
      const map = { '‡πê': '0', '‡πë': '1', '‡πí': '2', '‡πì': '3', '‡πî': '4', '‡πï': '5', '‡πñ': '6', '‡πó': '7', '‡πò': '8', '‡πô': '9' };
      return str.replace(/[‡πê-‡πô]/g, d => map[d] || d);
    }
    let _toastTimer = null;
    function toast(msg) {
      let el = document.getElementById('voiceToast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'voiceToast';
        el.style.position = 'fixed';
        el.style.bottom = '16px';
        el.style.right = '16px';
        el.style.padding = '10px 14px';
        el.style.background = '#1976D2';
        el.style.color = '#fff';
        el.style.borderRadius = '8px';
        el.style.boxShadow = '0 2px 8px rgba(0,0,0,.2)';
        el.style.zIndex = 9999;
        el.style.transition = 'opacity .2s';
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = '1';
      if (_toastTimer) clearTimeout(_toastTimer);
      _toastTimer = setTimeout(() => { el.style.opacity = '0'; }, 2000);
    }
    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'th-TH';
      window.speechSynthesis.speak(u);
    }
    function debounce(fn, ms = 200) {
      let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }
    }

    // ---------- Search ----------
    function filterCardsByQuery(q) {
      const query = toThaiLower(q).trim();
      const cards = document.querySelectorAll('#ingredientContainer .card');
      cards.forEach(card => {
        const title = card.querySelector('h3')?.textContent || '';
        const nameOnly = title.split(' (x')[0];
        const show = toThaiLower(nameOnly).includes(query);
        card.style.display = show ? '' : 'none';
      });
    }

    // ---------- Sort by days remaining ----------
    document.addEventListener("DOMContentLoaded", function () {
      const container = document.getElementById("ingredientContainer");
      const cards = Array.from(container.querySelectorAll(".card"));
      const sorted = cards.sort((a, b) => parseInt(a.dataset.days) - parseInt(b.dataset.days));
      sorted.forEach(card => container.appendChild(card));

      // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï delta ‡πÄ‡∏õ‡πá‡∏ô 0
      document.querySelectorAll('.confirm-bar').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.qty-delta').forEach(el => el.textContent = '0');
    });

    // ---------- Voice core ----------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognizer = null, listening = false;
    let wizardState = null;
    let payload = { name: '', quantity: 1, prepared_date: '', expiry_date: '' };

    function setStatus(t) {
      const s = document.getElementById('voiceStatus');
      if (s) s.textContent = t || '';
    }
    function ensureRecognizer() {
      if (!SpeechRecognition) { toast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á'); return null; }
      if (!recognizer) {
        recognizer = new SpeechRecognition();
        recognizer.lang = 'th-TH';
        recognizer.interimResults = false;
        recognizer.continuous = false;
        recognizer.onstart = () => { listening = true; setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‚Ä¶'); document.getElementById('voiceBtn')?.setAttribute('aria-pressed', 'true'); };
        recognizer.onend = () => { listening = false; setStatus(''); document.getElementById('voiceBtn')?.setAttribute('aria-pressed', 'false'); };
        recognizer.onerror = (e) => { listening = false; setStatus('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.error); toast('‡πÑ‡∏°‡∏Ñ‡πå‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.error); };
        recognizer.onresult = (ev) => {
          const raw = ev.results[0][0].transcript.trim();
          handleVoice(normalizeThaiDigits(raw));
        };
      }
      return recognizer;
    }
    function startListening() { const r = ensureRecognizer(); if (!r) return; if (listening) return; try { r.start(); } catch (e) { } }
    function stopListening() { if (recognizer && listening) { recognizer.stop(); } }

    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('voiceBtn');
      if (btn) {
        btn.addEventListener('click', () => { if (listening) stopListening(); else startListening(); });
      }
      const searchBox = document.getElementById('searchBox');
      if (searchBox) searchBox.addEventListener('input', debounce(e => filterCardsByQuery(e.target.value), 200));
    });

    // ---------- Date parsing ----------
    function parseIsoDateLike(t) {
      t = (t || '').replace(/\s+/g, '');
      const m1 = t.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
      if (m1) { const y = m1[1], mo = m1[2].padStart(2, '0'), d = m1[3].padStart(2, '0'); return `${y}-${mo}-${d}`; }
      const m2 = t.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
      if (m2) { const d = m2[1].padStart(2, '0'), mo = m2[2].padStart(2, '0'), y = m2[3]; return `${y}-${mo}-${d}`; }
      return '';
    }

    function parseSpeechDateToISO(input) {
      if (!input) return "";
      const thaiDigits = { '‡πê': '0', '‡πë': '1', '‡πí': '2', '‡πì': '3', '‡πî': '4', '‡πï': '5', '‡πñ': '6', '‡πó': '7', '‡πò': '8', '‡πô': '9' };
      const normDigits = s => s.replace(/[‡πê-‡πô]/g, d => thaiDigits[d] || d);
      let s = normDigits(String(input)).trim().toLowerCase().replace(/\s+/g, ' ').replace(/[\u200B-\u200D\uFEFF]/g, '');
      s = s.replace(/^(‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà|‡πÄ‡∏î‡∏ó|date)\s*/, '').replace(/(‡∏û‡∏®|‡∏û\.‡∏®\.)/g, '‡∏û‡∏®').replace(/(‡∏Ñ‡∏®|‡∏Ñ\.‡∏®\.)/g, '‡∏Ñ‡∏®');

      const now = new Date();
      const pad2 = n => String(n).padStart(2, '0');

      if (/^‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ$/.test(s)) return now.toISOString().slice(0, 10);
      if (/^‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ$/.test(s)) { const d = new Date(now); d.setDate(d.getDate() + 1); return d.toISOString().slice(0, 10); }
      if (/^‡∏°‡∏∞‡∏£‡∏∑‡∏ô(‡∏ô‡∏µ‡πâ)?$/.test(s)) { const d = new Date(now); d.setDate(d.getDate() + 2); return d.toISOString().slice(0, 10); }
      if (/^‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô$/.test(s)) { const d = new Date(now); d.setDate(d.getDate() - 1); return d.toISOString().slice(0, 10); }
      let mRel = s.match(/^‡∏≠‡∏µ‡∏Å\s*(\d+)\s*(‡∏ß‡∏±‡∏ô|‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå|‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå|‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)$/);
      if (mRel) {
        const d = new Date(now); const n = parseInt(mRel[1], 10);
        if (/‡∏ß‡∏±‡∏ô/.test(mRel[2])) d.setDate(d.getDate() + n);
        else if (/(‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå|‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå)/.test(mRel[2])) d.setDate(d.getDate() + 7 * n);
        else d.setMonth(d.getMonth() + n);
        return d.toISOString().slice(0, 10);
      }

      const TH_MONTHS = {
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°': 1, '‡∏°.‡∏Ñ.': 1, '‡∏°‡∏Ñ': 1, '‡∏°‡∏Å‡∏£‡∏≤': 1, '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå': 2, '‡∏Å.‡∏û.': 2, '‡∏Å‡∏û': 2,
        '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°': 3, '‡∏°‡∏µ.‡∏Ñ.': 3, '‡∏°‡∏µ‡∏Ñ': 3, '‡∏°‡∏µ‡∏ô‡∏≤': 3, '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô': 4, '‡πÄ‡∏°.‡∏¢.': 4, '‡πÄ‡∏°‡∏¢': 4,
        '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°': 5, '‡∏û.‡∏Ñ.': 5, '‡∏û‡∏Ñ': 5, '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô': 6, '‡∏°‡∏¥.‡∏¢.': 6, '‡∏°‡∏¥‡∏¢': 6,
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°': 7, '‡∏Å.‡∏Ñ.': 7, '‡∏Å‡∏Ñ': 7, '‡∏Å‡∏£‡∏Å‡∏é‡∏≤': 7, '‡∏Å‡∏£‡∏≤': 7, '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°': 8, '‡∏™.‡∏Ñ.': 8, '‡∏™‡∏Ñ': 8, '‡∏™‡∏¥‡∏á‡∏´‡∏≤': 8,
        '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô': 9, '‡∏Å.‡∏¢.': 9, '‡∏Å‡∏¢': 9, '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤': 9, '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°': 10, '‡∏ï.‡∏Ñ.': 10, '‡∏ï‡∏Ñ': 10, '‡∏ï‡∏∏‡∏•‡∏≤': 10,
        '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô': 11, '‡∏û.‡∏¢.': 11, '‡∏û‡∏¢': 11, '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤': 11, '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°': 12, '‡∏ò.‡∏Ñ.': 12, '‡∏ò‡∏Ñ': 12, '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤': 12
      };
      const EN_MONTHS = { jan: 1, january: 1, feb: 2, february: 2, mar: 3, march: 3, apr: 4, april: 4, may: 5, jun: 6, june: 6, jul: 7, july: 7, aug: 8, august: 8, sep: 9, sept: 9, september: 9, oct: 10, october: 10, nov: 11, november: 11, dec: 12, december: 12 };

      const normalizeYear = (yRaw) => {
        let y = parseInt(yRaw, 10); if (isNaN(y)) return null;
        if (/‡∏Ñ‡∏®/.test(s)) { if (y < 100) y += 2000; return y; }
        if (/‡∏û‡∏®/.test(s)) { if (y < 100) y += 2500; if (y < 2400) y += 543; return y; }
        if (y < 100) return 2000 + y;      // 68 -> 2068 (‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 2500+y)
        if (y > 2400) return y - 543;      // 2568 -> 2025
        return y;                          // 2025
      };

      let m = s.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
      if (m) { const y = normalizeYear(m[1]); const mo = +m[2]; const d = +m[3]; if (y) return `${y}-${pad2(mo)}-${pad2(d)}`; }
      m = s.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{2,4})$/);
      if (m) { const y = normalizeYear(m[3]); const mo = +m[2]; const d = +m[1]; if (y) return `${y}-${pad2(mo)}-${pad2(d)}`; }

      m = s.match(/^(\d{1,2})\s*([‡∏Å-‡πô\.]+)\s*(\d{2,4})?$/);
      if (m && TH_MONTHS[m[2]]) {
        const d = +m[1], mo = TH_MONTHS[m[2]]; let y = m[3] ? normalizeYear(m[3]) : now.getFullYear();
        if (!m[3]) { const test = new Date(now.getFullYear(), mo - 1, d); if (test < new Date(now.getFullYear(), now.getMonth(), now.getDate())) y += 1; }
        return `${y}-${pad2(mo)}-${pad2(d)}`;
      }

      m = s.match(/^(?:(\d{1,2})\s+([a-z]+)\s+(\d{2,4})|([a-z]+)\s+(\d{1,2})\s+(\d{2,4}))$/i);
      if (m) {
        let d, moName, y;
        if (m[1]) { d = +m[1]; moName = m[2]; y = normalizeYear(m[3]); }
        else { moName = m[4]; d = +m[5]; y = normalizeYear(m[6]); }
        const mo = EN_MONTHS[moName] || EN_MONTHS[moName?.slice(0, 3)];
        if (mo && y) return `${y}-${pad2(mo)}-${pad2(d)}`;
      }

      m = s.match(/^‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà?\s*(\d{1,2})\s*(‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)?\s*(\d{1,2})\s*(‡∏õ‡∏µ)?\s*(\d{2,4})$/);
      if (m) { const d = +m[1], mo = +m[3], y = normalizeYear(m[5]); if (y) return `${y}-${pad2(mo)}-${pad2(d)}`; }

      m = s.match(/^(\d{1,2})([‡∏Å-‡πô]+)(\d{2,4})?$/);
      if (m && TH_MONTHS[m[2]]) {
        const d = +m[1], mo = TH_MONTHS[m[2]]; const y = m[3] ? normalizeYear(m[3]) : now.getFullYear();
        return `${y}-${pad2(mo)}-${pad2(d)}`;
      }

      console.warn('Unparsed date phrase:', input);
      return "";
    }

    // ---------- Policy parsing (single version) ----------
    function policyFromThai(answer) {
      const raw = normalizeThaiDigits(answer || "");
      const t = raw.toLowerCase().trim();

      if (/(‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î|‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î|‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î|‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)/.test(t) || /\b(latest|newest)\b/.test(t)) return { policy: "newest" };
      if (/(‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î|‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î|‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤)/.test(t) || /\b(oldest)\b/.test(t)) return { policy: "oldest" };
      if (/(‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏|‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏∞‡∏´‡∏°‡∏î|‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î)/.test(t) || /\b(nearest\s*(expiry|expiration)|near\s*expiry|soonest\s*expiry)\b/.test(t)) return { policy: "nearest_expiry" };
      if (/(‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß|‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)/.test(t) || /\b(expired\s*only|already\s*expired|expired)\b/.test(t)) return { policy: "expired_only" };

      let iso = parseSpeechDateToISO(t);
      if (!iso) {
        const m = t.match(/(?:‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà|‡πÄ‡∏î‡∏ó|date)\s*(.+)$/);
        if (m) iso = parseSpeechDateToISO(m[1]);
      }
      if (iso) return { policy: "by_date", target_date: iso };

      return null;
    }

    // ---------- Voice: API helpers ----------
    async function submitVoicePayload() {
      try {
        if (!payload.expiry_date) { const d = new Date(); d.setDate(d.getDate() + 7); payload.expiry_date = d.toISOString().slice(0, 10); }

        const res = await fetch("{% url 'voice_add_ingredient' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        let data;
        try { data = await res.json(); } catch { throw new Error('JSON parse error'); }

        if (data.ok) { toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ' + payload.name); speak('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); window.location.reload(); }
        else { toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (data.error || '')); speak('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); }
      } catch (err) { toast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ' + err.message); speak('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
    }

    async function sendDeleteVoice({ name, amount, policy, target_date }) {
      const body = { name, amount, policy };
      if (target_date) body.target_date = target_date;

      try {
        const res = await fetch("{% url 'voice_delete_ingredient' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
          body: JSON.stringify(body),
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.ok) { const err = data.error || "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; toast(err); speak("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏î‡πâ"); return; }

        let msg = `‡∏•‡∏ö ${name} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`;
        if (policy === "expired_only") msg = `‡∏•‡∏ö ${name} ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
        else if (policy === "nearest_expiry") msg = `‡∏•‡∏ö ${name} ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
        else if (policy === "newest") msg = `‡∏•‡∏ö ${name} ‡∏•‡πá‡∏≠‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
        else if (policy === "oldest") msg = `‡∏•‡∏ö ${name} ‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;
        else if (policy === "by_date" && target_date) msg = `‡∏•‡∏ö ${name} ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${target_date} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`;

        toast(msg); speak(msg); setTimeout(() => location.reload(), 1200);
      } catch (err) {
        toast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message); speak("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö");
      }
    }

    async function probeLots(name) {
      try {
        const res = await fetch(`/api/lots/?name=${encodeURIComponent(name)}`);
        if (!res.ok) throw 0;
        return await res.json(); // {ok, lots, has_expired}
      } catch { return { ok: false }; }
    }

    function speakTH(text, opts = {}) {
      if (!('speechSynthesis' in window)) return;
      const synth = window.speechSynthesis; try { synth.cancel(); } catch (e) { }
      const u = new SpeechSynthesisUtterance(text); u.lang = 'th-TH';

      const pickVoice = () => {
        const vs = synth.getVoices() || [];
        const th = vs.find(v => /th(-|_|$)/i.test(v.lang) || /Thai/i.test(v.name));
        if (th) u.voice = th;
      };
      if (synth.onvoiceschanged !== undefined) synth.addEventListener('voiceschanged', pickVoice, { once: true });
      pickVoice();

      if (opts.rate) u.rate = opts.rate;
      if (opts.pitch) u.pitch = opts.pitch;
      u.onend = () => opts.onend && opts.onend();
      synth.speak(u);
    }

    function speakOut(text, { lang = 'en-US', rate, pitch, onend } = {}) {
      if (!('speechSynthesis' in window)) return;
      const synth = window.speechSynthesis; try { synth.cancel(); } catch (e) { }
      const u = new SpeechSynthesisUtterance(text); u.lang = lang;
      const pickVoice = () => {
        const vs = synth.getVoices() || [];
        const vv = vs.find(v => v.lang?.toLowerCase().startsWith(lang.toLowerCase()));
        if (vv) u.voice = vv;
      };
      if (synth.onvoiceschanged !== undefined) synth.addEventListener('voiceschanged', pickVoice, { once: true });
      pickVoice();
      if (rate) u.rate = rate; if (pitch) u.pitch = pitch;
      u.onend = () => onend && onend();
      synth.speak(u);
    }

    function speakEN_thenListenTH(promptText) {
      return new Promise((resolve) => {
        try { if (recognizer && listening) recognizer.stop(); } catch (e) { }
        speakOut(promptText, {
          lang: 'en-US',
          rate: 1.0,
          pitch: 1.0,
          onend: () => {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return resolve("");
            const r = new SR();
            r.lang = 'th-TH';
            r.interimResults = false;
            r.continuous = false;
            r.onresult = ev => resolve((ev.results?.[0]?.[0]?.transcript || '').trim());
            r.onerror = () => resolve("");
            try { r.start(); } catch { resolve(""); }
          }
        });
      });
    }

    async function disambiguateAndDelete({ name, amount }) {
      try {
        const info = await probeLots(name);
        const mustAsk = !info.ok || (info.ok && info.lots > 1);

        if (!mustAsk) return sendDeleteVoice({ name, amount, policy: "nearest_expiry" });

        const ans = await speakEN_thenListenTH("Which batch do you want to delete?");
        const pol = policyFromThai(ans);
        if (!pol) { toast("‡∏¢‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏"); return sendDeleteVoice({ name, amount, policy: "nearest_expiry" }); }
        return sendDeleteVoice({ name, amount, ...pol });
      } catch (e) { toast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (e.message || e)); }
    }

    // ---------- Voice: main handler ----------
    function parseOneShotAdd(thText) {
      const raw = normalizeThaiDigits(thText || "");
      const t = raw.toLocaleLowerCase('th-TH').replace(/\s+/g, ' ').trim();
      if (!/^(‡πÄ‡∏û‡∏¥‡πà‡∏°|‡πÉ‡∏™‡πà|‡πÅ‡∏≠‡∏î)/.test(t)) return null;
      let s = t.replace(/^(?:‡πÄ‡∏û‡∏¥‡πà‡∏°|‡πÉ‡∏™‡πà|‡πÅ‡∏≠‡∏î)\s*/, '').trim();

      let dateISO = "";
      const mDate = s.match(/(?:‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏|‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏|‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà|‡πÄ‡∏î‡∏ó|date)\s+(.+)$/i);
      if (mDate) {
        dateISO = parseSpeechDateToISO(mDate[1]);
        if (dateISO) s = s.slice(0, mDate.index).trim();
      }

      const unit = "(‡∏≠‡∏±‡∏ô|‡∏ä‡∏¥‡πâ‡∏ô|‡∏•‡∏π‡∏Å|‡∏ü‡∏≠‡∏á|‡∏Ç‡∏ß‡∏î|‡∏Å‡πâ‡∏≠‡∏ô|‡πÉ‡∏ö|‡∏Å‡∏¥‡πÇ‡∏•|‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°|‡πÅ‡∏û‡πá‡∏Ñ|‡πÅ‡∏û‡∏Ñ|‡∏ñ‡∏∏‡∏á)?";
      const patterns = [
        new RegExp(`^([^\\d].*?)\\s+(\\d+)\\s*${unit}$`),
        new RegExp(`^(\\d+)\\s*${unit}\\s+(.+?)$`),
        new RegExp(`^(.+?)$`)
      ];

      let name = "", qty = 1;
      let m = s.match(patterns[0]);
      if (m) { name = (m[1] || "").trim(); qty = parseInt(m[2], 10) || 1; }
      else {
        m = s.match(patterns[1]);
        if (m) { qty = parseInt(m[1], 10) || 1; name = (m[3] || m[2] || "").trim(); }
        else {
          const glued = s.match(/^([^\d]+?)(\d+)\s*(?:‡∏≠‡∏±‡∏ô|‡∏ä‡∏¥‡πâ‡∏ô|‡∏•‡∏π‡∏Å|‡∏ü‡∏≠‡∏á|‡∏Ç‡∏ß‡∏î|‡∏Å‡πâ‡∏≠‡∏ô|‡πÉ‡∏ö|‡∏Å‡∏¥‡πÇ‡∏•|‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°|‡πÅ‡∏û‡πá‡∏Ñ|‡πÅ‡∏û‡∏Ñ|‡∏ñ‡∏∏‡∏á)?$/);
          if (glued) { name = glued[1].trim(); qty = parseInt(glued[2], 10) || 1; }
          else { name = s.trim(); qty = 1; }
        }
      }

      name = name.replace(/\s+/g, ' ').trim();
      if (!name) return null;
      return { name, quantity: Math.max(1, qty), dateISO };
    }

    function handleVoice(text) {
      const t = toThaiLower(text);

      // One-shot add
      let addOS = parseOneShotAdd(t);
      if (addOS) {
        const today = new Date();
        const next7 = new Date(); next7.setDate(today.getDate() + 7);
        payload = {
          name: addOS.name,
          quantity: addOS.quantity,
          prepared_date: today.toISOString().slice(0, 10),
          expiry_date: addOS.dateISO || next7.toISOString().slice(0, 10)
        };
        if (addOS.dateISO) {
          wizardState = null;
          toast(`‡πÄ‡∏û‡∏¥‡πà‡∏°: ${payload.name} x${payload.quantity} (‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${payload.expiry_date})`);
          speak('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
          submitVoicePayload();
        } else {
          wizardState = 'expiry';
          toast(`‡πÄ‡∏û‡∏¥‡πà‡∏°: ${payload.name} x${payload.quantity} | ‡∏û‡∏π‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î "‡∏Ç‡πâ‡∏≤‡∏°"`);
          speak('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°');
        }
        return;
      }

      if (/(‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á)/.test(t)) { stopListening(); speak('‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß'); return; }
      if (/(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á)/.test(t)) { startListening(); return; }
      if (/(‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î|‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà|‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)/.test(t)) { location.reload(); return; }

      if (wizardState === null && /(‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö|‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á|‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)/.test(t)) {
        const today = new Date(); const next7 = new Date(); next7.setDate(today.getDate() + 7);
        payload = { name: '', quantity: 1, prepared_date: today.toISOString().slice(0, 10), expiry_date: next7.toISOString().slice(0, 10) };
        wizardState = 'name'; toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏ä‡∏∑‡πà‡∏≠'); speak('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö'); return;
      }
      if (wizardState === 'name') {
        let name = t.replace(/^‡∏ä‡∏∑‡πà‡∏≠\s*/, '').trim();
        if (!name) { toast('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏ä‡∏∑‡πà‡∏≠'); speak('‡∏Ç‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); return; }
        payload.name = name; wizardState = 'quantity';
        toast('‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠: ' + name + ' | ‡∏û‡∏π‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÄ‡∏ä‡πà‡∏ô 3'); speak('‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'); return;
      }
      if (wizardState === 'quantity') {
        let q = t.replace(/^‡∏à‡∏≥‡∏ô‡∏ß‡∏ô\s*/, '').trim().replace(/[^0-9]/g, '');
        const num = parseInt(q || '1', 10) || 1;
        payload.quantity = Math.max(1, num);
        wizardState = 'expiry';
        const d = new Date(); d.setDate(d.getDate() + 7);
        payload.expiry_date = d.toISOString().slice(0, 10);
        toast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ' + payload.quantity + ' | ‡∏û‡∏π‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î "‡∏Ç‡πâ‡∏≤‡∏°"'); speak('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°'); return;
      }
      if (wizardState === 'expiry') {
        const skip = /(‡∏Ç‡πâ‡∏≤‡∏°|‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ|‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏|‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà)/.test(t);
        if (!skip) {
          let s = t.replace(/^‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏\s*/, '').trim();
          let parsed = parseSpeechDateToISO(s) || parseIsoDateLike(s);
          if (parsed) payload.expiry_date = parsed;
        }
        if (!payload.expiry_date) { const d = new Date(); d.setDate(d.getDate() + 7); payload.expiry_date = d.toISOString().slice(0, 10); }
        wizardState = null; submitVoicePayload(); return;
      }

      // Search by voice
      let m = t.match(/^(‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤|‡∏´‡∏≤)\s+(.+)$/);
      if (m && m[2]) {
        const q = m[2].trim(); const box = document.getElementById('searchBox'); if (box) box.value = q;
        filterCardsByQuery(q); toast('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + q); speak('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'); return;
      }

      // Delete variants
      const unit = "(‡∏≠‡∏±‡∏ô|‡∏ä‡∏¥‡πâ‡∏ô|‡∏•‡∏π‡∏Å|‡∏ü‡∏≠‡∏á|‡∏Ç‡∏ß‡∏î|‡∏Å‡πâ‡∏≠‡∏ô|‡πÉ‡∏ö|‡∏Å‡∏¥‡πÇ‡∏•|‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°|‡πÅ‡∏û‡πá‡∏Ñ|‡πÅ‡∏û‡∏Ñ|‡∏ñ‡∏∏‡∏á)?";
      const cleanTH = (s) => (s || "").replace(/\s+/g, " ").trim();

      m = t.match(/^‡∏•‡∏ö\s*([^\d].*?)\s*(‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß|‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß)\s*$/);
      if (m) return disambiguateAndDelete({ name: cleanTH(m[1]), amount: "all", policy: "expired_only" });

      m = t.match(/^‡∏•‡∏ö\s*([^\d].*?)\s*(‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏|‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)\s*$/);
      if (m) return disambiguateAndDelete({ name: cleanTH(m[1]), amount: "all", policy: "nearest_expiry" });

      m = t.match(/^‡∏•‡∏ö\s*([^\d].*?)\s*(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≠‡∏á)\s*$/);
      if (m) return disambiguateAndDelete({ name: cleanTH(m[1]), amount: "all" });

      const patterns = [
        new RegExp(`^‡∏•‡∏ö\\s*([^\d].*?)\\s+(\\d+)\\s*${unit}\\s*$`),
        new RegExp(`^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å\\s*([^\d].*?)\\s+(\\d+)\\s*${unit}\\s*$`),
        new RegExp(`^‡∏•‡∏ö\\s*(\\d+)\\s*${unit}\\s+(.+?)\\s*$`),
        // ‡πÅ‡∏Å‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‚Üì
        new RegExp(`^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å\\s*(\\d+)\\s*${unit}\\s+(.+?)\\s*$`),
        new RegExp(`^‡∏•‡∏ö([^\d].*?)(\\d+)\\s*${unit}\\s*$`),
        new RegExp(`^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å([^\d].*?)(\\d+)\\s*${unit}\\s*$`) // ‚Üê ‡∏≠‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô \\d+
      ];
      for (const re of patterns) {
        m = t.match(re);
        if (m) {
          let name, num;
          if (re === patterns[2] || re === patterns[3]) { num = parseInt(m[1], 10); name = cleanTH(m[3] || m[2]); }
          else { name = cleanTH(m[1] || m[4] || ""); num = parseInt(m[2], 10); }
          if (name && num > 0) return disambiguateAndDelete({ name, amount: num });
        }
      }

      m = t.match(/^‡∏•‡∏ö\s*(.+)\s*$/) || t.match(/^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å\s*(.+)\s*$/);
      if (m) return disambiguateAndDelete({ name: cleanTH(m[1]), amount: "all" });

      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ' + text);
    }

    // ---------- Quantity editor ----------
    document.addEventListener('click', async (e) => {
      // --- ‡∏õ‡∏∏‡πà‡∏° - / + ---
      const stepBtn = e.target.closest('.qty-step');
      if (stepBtn) {
        const wrap = stepBtn.closest('.qty-editor');
        const id = wrap.dataset.iid;
        const step = parseInt(stepBtn.dataset.step, 10);

        const span = document.getElementById(`delta-${id}`);
        const currentDelta = parseInt(span.textContent || '0', 10);

        const have = parseInt(wrap.dataset.qty || '0', 10); // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á
        let next = currentDelta + step;

        // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ 4 ‡∏Å‡πá‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ -4)
        const minDelta = -have;
        if (next < minDelta) next = minDelta;

        span.textContent = next;

        // ‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        const bar = document.getElementById(`confirm-${id}`);
        bar.classList.toggle('hidden', next === 0);
        return;
      }

      // --- ‡∏õ‡∏∏‡πà‡∏° ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ---
      const cancelBtn = e.target.closest('.btn-cancel');
      if (cancelBtn) {
        const id = cancelBtn.dataset.iid;
        document.getElementById(`delta-${id}`).textContent = '0';
        document.getElementById(`confirm-${id}`).classList.add('hidden');
        return;
      }

      // --- ‡∏õ‡∏∏‡πà‡∏° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ---
      const saveBtn = e.target.closest('.btn-save');
      if (saveBtn) {
        const id = saveBtn.dataset.iid;
        const span = document.getElementById(`delta-${id}`);
        const delta = parseInt(span.textContent || '0', 10);
        if (delta === 0) return;

        const urlInc = "{% url 'increment_ingredient' 0 %}".replace("/0/", `/${id}/`);
        const urlDec = "{% url 'decrement_ingredient' 0 %}".replace("/0/", `/${id}/`);

        const postOnce = async (url) => {
          const res = await fetch(url, { method: "POST", headers: { "X-CSRFToken": csrftoken } });
          let data = null;
          try { data = await res.json(); } catch { }
          if (!res.ok || (data && data.ok === false)) {
            const msg = (data && (data.error || data.detail)) || `HTTP ${res.status}`;
            throw new Error(msg);
          }
          return data;
        };

        try {
          if (delta > 0) {
            for (let i = 0; i < delta; i++) await postOnce(urlInc);
          } else {
            for (let i = 0; i < Math.abs(delta); i++) {
              const res = await postOnce(urlDec);
              if (res.deleted) break; // ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏î‡∏ï‡πà‡∏≠
            }
          }
          location.reload();
        } catch (err) {
          alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
        }
      }
    });

    // ---------- Recipe modal (single path via showOnly) ----------
    let currentIngredient = null;
    let cacheLocal = null, cacheApi = null;

    function closeModal() { document.getElementById("recipeModal").classList.remove('is-show'); }

    function setActiveSourceButton(src) {
      document.querySelectorAll('#recipeModal .src-btn').forEach(b => {
        b.classList.toggle('is-active', b.dataset.source === src);
      });
    }

    async function fetchSection(ingredientName, source) {
      const url = `/api/recipes/${encodeURIComponent(ingredientName)}/?source=${source}&limit=10`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`${res.status}: ${await res.text()}`);
      let data; try { data = await res.json(); } catch { throw new Error('JSON parse error'); }
      return data;
    }

    function buildYTHowtoLink(dish) {
      const q = (dish || '').trim().replace(/\s+/g, ' ');
      return 'https://www.youtube.com/results?search_query=' + encodeURIComponent(`${q} ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥`);
    }

    const HOWTO_URL = "{% url 'api_howto' %}";
    const HOWTO_ALL_URL = "{% url 'api_howto_all' %}";

    async function fetchHowto(name) {
      const res = await fetch(HOWTO_URL + '?q=' + encodeURIComponent(name), { headers: { 'Accept': 'application/json' } });
      let data; try { data = await res.json(); } catch { throw new Error('JSON parse error'); }
      if (!res.ok || data.ok === false) throw new Error(data.error || ('HTTP ' + res.status));
      return data; // {title, ingredients, steps, videos?}
    }

    async function fetchHowtoFromStatic(name) {
      const res = await fetch(HOWTO_ALL_URL, { headers: { 'Accept': 'application/json' } });
      let data; try { data = await res.json(); } catch { throw new Error('JSON parse error'); }

      const _normalizeName = (s) => (s || '').trim().toLocaleLowerCase('th-TH').replace(/\s+/g, ' ');
      let root = data;
      if (root && typeof root === 'object' && !Array.isArray(root) && root.recipes) root = root.recipes;

      const want = _normalizeName(name);
      let found = null;

      if (root && typeof root === 'object' && !Array.isArray(root)) {
        for (const k of Object.keys(root)) {
          if (_normalizeName(k) === want) { found = root[k]; break; }
        }
        if (!found) {
          for (const v of Object.values(root)) {
            if (_normalizeName(v?.title || v?.name || '') === want) { found = v; break; }
          }
        }
      }
      if (!found && Array.isArray(root))
        found = root.find(x => _normalizeName(x.title || x.name) === want) || null;

      if (!found && root && Array.isArray(root.items))
        found = root.items.find(x => _normalizeName(x.title || x.name) === want) || null;

      if (!found) throw new Error('not-found');
      return {
        title: found.title || found.name || name,
        ingredients: Array.isArray(found.ingredients) ? found.ingredients : [],
        steps: Array.isArray(found.steps) ? found.steps : [],
        videos: Array.isArray(found.videos) ? found.videos : []
      };
    }

    function renderHowtoModal(data, fallbackName) {
      const title = data.title || fallbackName || '';
      document.getElementById('howtoTitle').textContent = title;

      const ing = (data.ingredients || []);
      document.getElementById('howtoIngredients').textContent = ing.length ? ('‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö: ' + ing.join(', ')) : '';

      const stepsWrap = document.getElementById('howtoSteps');
      stepsWrap.innerHTML = '';
      const steps = (data.steps || []);
      if (steps.length) {
        steps.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          stepsWrap.appendChild(li);
        });
      } else {
        const li = document.createElement('li'); li.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö'; stepsWrap.appendChild(li);
      }

      const links = document.getElementById('howtoLinks');
      links.innerHTML = '';
      const yt = document.createElement('a');
      yt.href = buildYTHowtoLink(title);
      yt.target = '_blank'; yt.rel = 'noopener';
      yt.className = 'btn-primary';
      yt.style.display = 'inline-block';
      yt.textContent = '‡πÑ‡∏õ‡∏î‡∏π‡∏ö‡∏ô YouTube';
      links.appendChild(yt);

      (data.videos || []).forEach(v => {
        const a = document.createElement('a');
        a.href = v.url; a.target = '_blank'; a.rel = 'noopener';
        a.style.marginLeft = '8px';
        a.textContent = v.title || v.url;
        links.appendChild(a);
      });

      document.getElementById('howtoModal').style.display = 'flex';
    }

    async function openHowtoSmart(dishName) {
      try { const d = await fetchHowto(dishName); return renderHowtoModal(d, dishName); } catch (_) { }
      try { const d = await fetchHowtoFromStatic(dishName); return renderHowtoModal(d, dishName); } catch (_) { }
      return renderHowtoModal({ title: dishName, steps: [] }, dishName);
    }

    function showOnly(data, title = "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå") {
      const list = document.getElementById("recipeList");
      list.innerHTML = "";

      const h = document.createElement("div");
      h.className = "section-title";
      h.textContent = title;
      list.appendChild(h);

      if (!Array.isArray(data) || data.length === 0) {
        const li = document.createElement("li");
        li.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ";
        list.appendChild(li);
        return;
      }

      data.forEach(r => {
        const name = r.title || r.name || "‡πÄ‡∏°‡∏ô‡∏π";

        const li = document.createElement("li");
        li.className = "recipe-item";

        const header = document.createElement("div");
        header.className = "recipe-header";

        const titleEl = document.createElement("p");
        titleEl.className = "recipe-title";
        titleEl.textContent = name;

        const btn = document.createElement("button");
        btn.className = "howto-btn";
        btn.textContent = "‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥";
        btn.onclick = () => openHowtoSmart(name);

        header.appendChild(titleEl);
        header.appendChild(btn);

        const meta = document.createElement("div");
        meta.className = "recipe-meta";
        const used = (r.used || []).join(", ") || "-";
        const missing = (r.missing || []).join(", ") || "-";
        const metaHTML = document.createElement('div');
        // ‡πÉ‡∏ä‡πâ safe HTML ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÅ‡∏ó‡∏£‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á‡πÑ‡∏õ)
        metaHTML.innerHTML = `<span class="ok">‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:</span> ${used}<br><span class="miss">‡∏Ç‡∏≤‡∏î:</span> ${missing}`;
        meta.appendChild(metaHTML);

        li.appendChild(header);
        li.appendChild(meta);
        list.appendChild(li);
      });
    }

    async function openRecipes(ingredientName) {
      currentIngredient = ingredientName;
      cacheLocal = null; cacheApi = null;

      document.getElementById("recipeTitle").textContent = `‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å: ${ingredientName}`;
      const list = document.getElementById("recipeList");
      list.innerHTML = "";
      const loading = document.createElement("li");
      loading.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Local‚Ä¶";
      list.appendChild(loading);

      document.getElementById("recipeModal").classList.add('is-show');
      setActiveSourceButton("local");

      try {
        cacheLocal = await fetchSection(ingredientName, "local");
      } catch (e) {
        cacheLocal = [];
        console.warn("Local error:", e);
      }
      showOnly(cacheLocal, "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢");

      // preload API
      try {
        cacheApi = await fetchSection(ingredientName, "api");
      } catch (e) {
        cacheApi = [];
        console.warn("API error:", e);
      }
    }

    // bind once (‡∏ô‡∏≠‡∏Å showOnly)
    document.getElementById('btnSourceLocal')?.addEventListener('click', () => {
      setActiveSourceButton("local"); showOnly(cacheLocal, "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢");
    });
    document.getElementById('btnSourceApi')?.addEventListener('click', () => {
      setActiveSourceButton("api"); showOnly(cacheApi, "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥");
    });
    document.getElementById('recipeModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'recipeModal') { closeModal(); }
    });
  </script>
</body>

</html>