{% load static %}
<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      background-color: #f0f8ff;
      color: #37474F;
      margin: 0;
      padding: 0;
    }

    .navbar {
      background-color: #ffffff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #90CAF9;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .navbar-logo {
      font-size: 20px;
      font-weight: 600;
      color: #1976D2;
    }

    .navbar-menu {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    .navbar-menu li a {
      text-decoration: none;
      color: #37474F;
      font-weight: 500;
      transition: color 0.2s;
    }

    .navbar-menu li a:hover {
      color: #0D47A1;
    }

    .container {
      max-width: 1400px;
      margin: auto;
      padding: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      /* 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß */
      gap: 20px;
    }

    /* Responsive: ‡∏•‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Responsive: ‡∏•‡∏î‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å */
    @media (max-width: 500px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .card-body {
      padding: 16px;
    }

    .badge {
      border-radius: 8px;
      padding: 4px 8px;
      font-weight: 500;
      display: inline-block;
    }

    .badge-safe {
      background-color: #E8F5E9;
      color: #2E7D32;
    }

    .badge-warning {
      background-color: #FFF8E1;
      color: #F57F17;
    }

    .badge-danger {
      background-color: #FFEBEE;
      color: #C62828;
    }

    /* ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 2 ‡πÅ‡∏ñ‡∏ß */
    .grid-latest {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏•‡πá‡∏Å */
    .card-small img {
      height: 120px;
    }

    .card-small .card-body {
      padding: 10px;
    }

    .card-small h3 {
      font-size: 14px;
    }

    .card-small p {
      font-size: 12px;
    }

    #voiceStatus {
      font-size: 12px;
      color: #1976D2;
      margin-left: 8px;
    }

    #helpVoice {
      font-size: 12px;
      color: #555;
      margin-top: 6px;
    }

    .btn-primary {
      margin-top: 12px;
      background: #1976D2;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-logo">KitchenSync</div>
    <ul class="navbar-menu">
      <li><a href="{% url 'add_ingredient' %}">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</a></li>
      <li><a href="{% url 'suggest' %}">‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h1>

    <div style="display:flex; align-items:center; gap:10px;">
      <input id="searchBox" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶"
        style="padding:8px 10px;border:1px solid #90CAF9;border-radius:8px;outline:none;">
      <button id="voiceBtn"
        style="border:none;background:#1976D2;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;">
        üé§ 
      </button>
    </div>

    <div style="margin-bottom: 24px;">
  
      <div>
        <h2>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <div class="grid" id="ingredientContainer">
          {% for ing in ingredients %}
          <div class="card" data-days="{{ ing.days_remaining }}">
            {% with url=ing.image_url %}
            {% if url %}
            <img src="{{ url }}" alt="{{ ing.name }}" style="cursor:pointer;"
              onclick="fetchRecipes('{{ ing.name|escapejs }}')" />
            {% else %}
            <div
              style="width:100%;height:200px;display:flex;align-items:center;justify-content:center;background:#eee;color:#888;"
              onclick="fetchRecipes('{{ ing.name|escapejs }}')">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </div>
            {% endif %}
            {% endwith %}
            <div class="card-body">
              <h3>{{ ing.name }} (x{{ ing.quantity }})</h3>
              <p>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: {{ ing.expiry_date }}</p>
              <p>
                {% if ing.days_remaining > 5 %}
                <span class="badge badge-safe">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {{ ing.days_remaining }} ‡∏ß‡∏±‡∏ô</span>
                {% elif ing.days_remaining > 2 %}
                <span class="badge badge-warning">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {{ ing.days_remaining }} ‡∏ß‡∏±‡∏ô</span>
                {% elif ing.days_remaining < 1 %} <span class="badge badge-danger">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span>
                  {% else %}
                  <span class="badge badge-danger">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {{ ing.days_remaining }} ‡∏ß‡∏±‡∏ô</span>
                  {% endif %}
              </p>
              <div style="display:flex;justify-content:center;gap:10px;margin-top:8px;">
                <!-- ‡∏õ‡∏∏‡πà‡∏° -1 -->
                <form method="post" action="{% url 'decrement_ingredient' ing.id %}">
                  {% csrf_token %}
                  <button type="submit"
                    style="background:#FFB300;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;">
                    -1
                  </button>
                </form>

                <!-- ‡∏õ‡∏∏‡πà‡∏° +1 -->
                <form method="post" action="{% url 'increment_ingredient' ing.id %}">
                  {% csrf_token %}
                  <button type="submit"
                    style="background:#388E3C;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;">
                    +1
                  </button>
                </form>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                <form method="post" action="{% url 'delete_ingredient' ing.id %}" onsubmit="return confirm('‡∏•‡∏ö \" {{
                  ing.name }}\" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?');">
                  {% csrf_token %}
                  <button type="submit"
                    style="background:#E53935;border:none;color:#fff;padding:6px 12px;border-radius:6px;cursor:pointer;">
                    ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                  </button>
                </form>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
      <button onclick="closeModal()" class="btn-primary">
        ‡∏õ‡∏¥‡∏î
      </button>
  <!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π -->
  <div id="recipeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:10000;">
    <div style="background:#fff; padding:20px; border-radius:12px; width:500px; max-height:80%; overflow:auto;">
      <h2 id="recipeTitle">‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
      <ul id="recipeList"></ul>
      <button onclick="closeModal()" style="margin-top:12px; background:#1976D2; color:#fff; border:none;
             padding:6px 12px; border-radius:6px; cursor:pointer;">
        ‡∏õ‡∏¥‡∏î
      </button>
    </div>
  </div>

  <script>

    async function fetchRecipes(ingredientName) {
      try {
        const url = `/api/recipes/${encodeURIComponent(ingredientName)}/`;
        const res = await fetch(url);
        const data = await res.json();

        console.log("DEBUG response:", data);

        const list = document.getElementById("recipeList");
        list.innerHTML = "";

        if (Array.isArray(data) && data.length > 0) {
          data.forEach(r => {
            const li = document.createElement("li");
            li.innerHTML = `
          <strong>${r.title}</strong><br>
          <img src="${r.image}" style="width:100px;border-radius:8px;">
        `;
            list.appendChild(li);
          });
        } else {
          list.innerHTML = "<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ</li>";
        }

        document.getElementById("recipeTitle").textContent = "‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å: " + ingredientName;
        document.getElementById("recipeModal").style.display = "flex";

      } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
      }
    }

    function closeModal() {
      document.getElementById("recipeModal").style.display = "none";
    }


    // ----- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡πà‡∏≠‡∏ô -----
    document.addEventListener("DOMContentLoaded", function () {
      const container = document.getElementById("ingredientContainer");
      const cards = Array.from(container.querySelectorAll(".card"));
      const sorted = cards.sort((a, b) => parseInt(a.dataset.days) - parseInt(b.dataset.days));
      sorted.forEach(card => container.appendChild(card));
    });

    // ----- Utilities -----
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    function toThaiLower(s) { return (s || '').toLocaleLowerCase('th-TH'); }
    function normalizeThaiDigits(str) {
      if (!str) return '';
      const map = { '‡πê': '0', '‡πë': '1', '‡πí': '2', '‡πì': '3', '‡πî': '4', '‡πï': '5', '‡πñ': '6', '‡πó': '7', '‡πò': '8', '‡πô': '9' };
      return str.replace(/[‡πê-‡πô]/g, d => map[d] || d);
    }
    function toast(msg) {
      let el = document.getElementById('voiceToast');
      if (!el) {
        el = document.createElement('div');
        el.id = 'voiceToast';
        el.style.position = 'fixed';
        el.style.bottom = '16px';
        el.style.right = '16px';
        el.style.padding = '10px 14px';
        el.style.background = '#1976D2';
        el.style.color = '#fff';
        el.style.borderRadius = '8px';
        el.style.boxShadow = '0 2px 8px rgba(0,0,0,.2)';
        el.style.zIndex = 9999;
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = '1';
      setTimeout(() => { el.style.opacity = '0'; }, 2000);
    }
    function speak(text) {
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'th-TH';
      window.speechSynthesis.speak(u);
    }

    // ----- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -----
    function filterCardsByQuery(q) {
      const query = toThaiLower(q).trim();
      const cards = document.querySelectorAll('#ingredientContainer .card');
      cards.forEach(card => {
        const title = card.querySelector('h3')?.textContent || '';
        const nameOnly = title.split(' (x')[0];
        const show = toThaiLower(nameOnly).includes(query);
        card.style.display = show ? '' : 'none';
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      const searchBox = document.getElementById('searchBox');
      if (searchBox) {
        searchBox.addEventListener('input', e => filterCardsByQuery(e.target.value));
      }
    });

    // ----- ‡∏•‡∏ö‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (API) -----
    async function voiceDelete(name, amount) {
      try {
        const res = await fetch("{% url 'voice_delete_ingredient' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
          body: JSON.stringify({ name, amount })
        });
        const data = await res.json();
        if (!data.ok) { toast(data.error || "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); speak("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }
        if (data.deleted_all) { toast(`‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${name}`); speak("‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß"); }
        else { toast(`‡∏•‡∏ö ${name} ‡∏≠‡∏≠‡∏Å ${data.deleted} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${data.remaining}`); speak(`‡∏•‡∏ö‡∏≠‡∏≠‡∏Å ${data.deleted} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${data.remaining}`); }
        window.location.reload();
      } catch (err) { toast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err); speak("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
    }

    // ----- Voice Wizard: ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏•‡∏ö -----
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognizer = null, listening = false;
    let wizardState = null;
    let payload = { name: '', quantity: 1, prepared_date: '', expiry_date: '' };

    function setStatus(t) {
      let s = document.getElementById('voiceStatus');
      if (!s) { s = document.createElement('span'); s.id = 'voiceStatus'; }
      const nav = document.querySelector('.navbar');
      if (nav && !s.parentNode) nav.appendChild(s);
      s.textContent = t || '';
    }
    function ensureRecognizer() {
      if (!SpeechRecognition) { alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á'); return null; }
      if (!recognizer) {
        recognizer = new SpeechRecognition();
        recognizer.lang = 'th-TH';
        recognizer.interimResults = false;
        recognizer.continuous = false;
        recognizer.onstart = () => { listening = true; setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‚Ä¶'); };
        recognizer.onend = () => { listening = false; setStatus(''); };
        recognizer.onerror = (e) => { listening = false; setStatus('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.error); };
        recognizer.onresult = (ev) => {
          const raw = ev.results[0][0].transcript.trim();
          handleVoice(normalizeThaiDigits(raw));
        };
      }
      return recognizer;
    }
    function startListening() { const r = ensureRecognizer(); if (!r) return; if (listening) return; try { r.start(); } catch (e) { } }
    function stopListening() { if (recognizer && listening) { recognizer.stop(); } }
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('voiceBtn');
      if (btn) { btn.addEventListener('click', () => { if (listening) stopListening(); else startListening(); }); }
    });

    function parseIsoDateLike(t) {
      t = (t || '').replace(/\s+/g, '');
      const m1 = t.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
      if (m1) { const y = m1[1], mo = m1[2].padStart(2, '0'), d = m1[3].padStart(2, '0'); return `${y}-${mo}-${d}`; }
      const m2 = t.match(/^(\d{1,2})[/-](\d{1,2})[/-](\d{4})$/);
      if (m2) { const d = m2[1].padStart(2, '0'), mo = m2[2].padStart(2, '0'), y = m2[3]; return `${y}-${mo}-${d}`; }
      return '';
    }

    async function submitVoicePayload() {
      try {
        const res = await fetch("{% url 'voice_add_ingredient' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken, },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.ok) {
          toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ' + payload.name); speak('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          window.location.reload();
        } else {
          toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (data.error || '')); speak('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
        }
      } catch (err) { toast('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ' + err); speak('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
    }

    function handleVoice(text) {
      const t = toThaiLower(text);

      // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö
      if (/(‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á)/.test(t)) { stopListening(); speak('‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß'); return; }
      if (/(‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á)/.test(t)) { startListening(); return; }
      if (/(‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î|‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà|‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)/.test(t)) { location.reload(); return; }

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ã‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°
      if (wizardState === null && /(‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö|‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á|‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)/.test(t)) {
        payload = { name: '', quantity: 1, prepared_date: new Date().toISOString().slice(0, 10), expiry_date: '' };
        wizardState = 'name';
        toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏ä‡∏∑‡πà‡∏≠'); speak('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö'); return;
      }
      if (wizardState === 'name') {
        let name = t.replace(/^‡∏ä‡∏∑‡πà‡∏≠\s*/, '').trim();
        if (!name) { toast('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏ä‡∏∑‡πà‡∏≠'); speak('‡∏Ç‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); return; }
        payload.name = name; wizardState = 'quantity';
        toast('‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠: ' + name + ' | ‡∏û‡∏π‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πÄ‡∏ä‡πà‡∏ô 3'); speak('‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'); return;
      }
      if (wizardState === 'quantity') {
        let q = t.replace(/^‡∏à‡∏≥‡∏ô‡∏ß‡∏ô\s*/, '').trim();
        q = q.replace(/[^0-9]/g, '');
        const num = parseInt(q || '1', 10) || 1;
        payload.quantity = Math.max(1, num);
        wizardState = 'expiry';
        const d = new Date(); d.setDate(d.getDate() + 7);
        payload.expiry_date = d.toISOString().slice(0, 10);
        toast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ' + payload.quantity + ' | ‡∏û‡∏π‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î "‡∏Ç‡πâ‡∏≤‡∏°"');
        speak('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏π‡∏î‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏°'); return;
      }
      if (wizardState === 'expiry') {
        if (!t.includes('‡∏Ç‡πâ‡∏≤‡∏°')) {
          let s = t.replace(/^‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏\s*/, '').trim();
          const parsed = parseIsoDateLike(s);
          if (parsed) payload.expiry_date = parsed;
        }
        wizardState = null; submitVoicePayload(); return;
      }

      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      let m = t.match(/^(‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤|‡∏´‡∏≤)\s+(.+)$/);
      if (m && m[2]) {
        const q = m[2].trim(); const box = document.getElementById('searchBox'); if (box) box.value = q;
        filterCardsByQuery(q); toast('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ' + q); speak('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤'); return;
      }

      // ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡∏•‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
      const unit = "(‡∏≠‡∏±‡∏ô|‡∏ä‡∏¥‡πâ‡∏ô|‡∏•‡∏π‡∏Å|‡∏ü‡∏≠‡∏á|‡∏Ç‡∏ß‡∏î|‡∏Å‡πâ‡∏≠‡∏ô|‡πÉ‡∏ö|‡∏Å‡∏¥‡πÇ‡∏•|‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°|‡πÅ‡∏û‡πá‡∏Ñ|‡∏ñ‡∏∏‡∏á)?";
      m = t.match(/^‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\s*(.+)\s*$/) || t.match(/^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\s*(.+)\s*$/);
      if (m) { const name = m[1].trim(); if (name) { voiceDelete(name, "all"); return; } }
      m = t.match(/^‡∏•‡∏ö\s*(.+?)\s*(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≠‡∏á)\s*$/) || t.match(/^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å\s*(.+?)\s*(‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏≠‡∏á)\s*$/);
      if (m) { voiceDelete(m[1].trim(), "all"); return; }

      const patterns = [
              new RegExp(`^‡∏•‡∏ö\\s*(.+?)\\s+(\\d+)\\s*${unit}\\s*$`),
              new RegExp(`^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å\\s*(.+?)\\s+(\\d+)\\s*${unit}\\s*$`),
              new RegExp(`^‡∏•‡∏ö\\s*(\\d+)\\s*${unit}\\s+(.+?)\\s*$`),
              new RegExp(`^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å\\s*(\\d+)\\s*${unit}\\s+(.+?)\\s*$`),
              new RegExp(`^‡∏•‡∏ö(.+?)(\\d+)\\s*${unit}\\s*$`),
              new RegExp(`^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å(.+?)(\\d+)\\s*${unit}\\s*$`)
            ];
            for (const re of patterns) {
        m = t.match(re);
        if (m) {
          let name, num;
          if (re === patterns[2] || re === patterns[3]) { // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            num = parseInt(m[1], 10); name = (m[3] || m[2]).trim();
          } else {                                        // ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            name = (m[1] || m[4] || "").trim(); num = parseInt(m[2], 10);
          }
          if (name && num > 0) { voiceDelete(name, num); return; }
        }
      }
      m = t.match(/^‡∏•‡∏ö\s+(.+)\s*$/) || t.match(/^‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å\s+(.+)\s*$/);
      if (m) { voiceDelete(m[1].trim(), "all"); return; }

      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ' + text);
    }

    function renderRecipes(data, ingredientName) {
      const list = document.getElementById("recipeList");
      list.innerHTML = "";

      if (!Array.isArray(data) || data.length === 0) {
        list.innerHTML = "<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ</li>";
      } else {
        data.forEach(r => {
          const title = r.title || r.name || "‡πÄ‡∏°‡∏ô‡∏π";
          const img = r.image ? `<img src="${r.image}" style="width:100px;border-radius:8px;">` : "";
          const li = document.createElement("li");
          li.innerHTML = `<strong>${title}</strong><br>${img}`;
          list.appendChild(li);
        });
      }
      document.getElementById("recipeTitle").textContent = "‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å: " + ingredientName;
      document.getElementById("recipeModal").style.display = "flex";
    }

    async function fetchRecipes(ingredientName) {
      try {
        const url = `/api/recipes/${encodeURIComponent(ingredientName)}/`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("API Error");
        const data = await res.json();

        if (Array.isArray(data) && data.length > 0) {
          renderRecipes(data, ingredientName);
          return;
        }
        throw new Error("API Empty");

      } catch (err) {
        console.warn("‚ö†Ô∏è Spoonacular ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ, fallback local:", err);

        try {
          const localRes = await fetch("/api/local_recipes/");
          if (!localRes.ok) {
            const txt = await localRes.text();
            throw new Error(`local_recipes ${localRes.status}: ${txt}`);
          }
          const localData = await localRes.json();

          const key = (ingredientName || "").toLowerCase();
          const matched = (localData || []).filter(r =>
            Array.isArray(r.ingredients) &&
            r.ingredients.some(x => (x || "").toLowerCase().includes(key))
          );

          renderRecipes(matched.length ? matched : localData, ingredientName);
        } catch (e2) {
          console.error("[Fallback local failed]", e2);
          alert("‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î Console/Network ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î error ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
        }
      }
    }


  </script>

</body>

</html>