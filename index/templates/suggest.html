{% load static %}
<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <title>‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      background-color: #f0f8ff;
      color: #37474F;
      margin: 0;
      padding: 0;
    }

    .navbar {
      background-color: #ffffff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #90CAF9;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .navbar-logo {
      font-size: 20px;
      font-weight: 600;
      color: #1976D2;
    }

    .navbar-menu {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    .navbar-menu li a {
      text-decoration: none;
      color: #37474F;
      font-weight: 500;
      transition: color 0.2s;
    }

    .navbar-menu li a:hover {
      color: #0D47A1;
    }

    .container {
      max-width: 1000px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input[type=text] {
      flex: 1;
      padding: 10px;
      border: 1px solid #90CAF9;
      border-radius: 8px;
    }

    button {
      background: #1976D2;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .05);
      padding: 16px;
      margin-top: 16px;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      margin: 4px 6px 0 0;
      font-size: 14px;
    }

    .pill.have {
      background: #E8F5E9;
      color: #2E7D32;
    }

    .pill.missing {
      background: #FFEBEE;
      color: #C62828;
    }

    #voiceStatus {
      font-size: 12px;
      color: #1976D2;
      margin-left: 8px;
    }

    .recipe-have {
      color: #16a34a;
      margin: 8px 0;
    }

    .recipe-missing {
      color: #dc2626;
      margin: 8px 0;
    }

    /* Modal */
    #howtoModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      justify-content: center;
      align-items: center;
      z-index: 10001;
    }

    .modal-shell {
      background: #fff;
      width: min(720px, 92vw);
      max-height: 85vh;
      overflow: auto;
      border-radius: 14px;
      padding: 18px;
    }

    .howto-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .btn {
      background: #e2e8f0;
      color: #0f172a;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-ghost {
      background: transparent;
      color: #2563eb;
      border: 1px solid #93c5fd;
    }

    .howto-steps {
      margin: 16px 0;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="navbar-logo">KitchenSync</div>
    <ul class="navbar-menu">
      <li><a href="{% url 'index' %}">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a></li>
      <li><a href="{% url 'add_ingredient' %}">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h1>

    <div class="row">
      <input id="q" type="text" placeholder="‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π ‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏±‡∏î‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤">
      <button id="mic" aria-label="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üé§</button>
      <button id="go">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <span id="voiceStatus"></span>
    </div>

    <div class="card" id="daily" style="margin-top:16px;">
      <h2>‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>

      <h3 style="margin:6px 0 8px;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥</h3>
      <div id="dailyGridApi" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;"></div>

      <h3 style="margin:16px 0 8px;">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢</h3>
      <div id="dailyGridLocal" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;"></div>
    </div>

    <div id="result" class="card" style="display:none;">
      <h2 id="dish"></h2>
      <h3>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ:</h3>
      <div id="all"></div>

      <h3 style="margin-top:12px;">‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <div id="have"></div>

      <h3 style="margin-top:12px;">‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î</h3>
      <div id="missing"></div>
    </div>
  </div>

  <!-- HOWTO Modal -->
  <div id="howtoModal" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
    <div class="modal-shell">
      <div class="howto-header">
        <h2 id="howtoTitle" style="margin:0;">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥</h2>
        <div style="display:flex; gap:8px;">
          <button id="btnClose" class="btn" type="button">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
      <div id="howtoIngredients" style="margin:6px 0 10px; color:#475569"></div>
      <ol id="howtoSteps" class="howto-steps" style="padding-left:20px"></ol>
      <div id="howtoLinks" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    // ================== Config ==================
    const HOWTO_URL = "{% url 'api_howto' %}";
    window.HOWTO_STATIC = "{% url 'api_howto_all' %}";

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
    window.CURRENT_INGREDIENTS = Array.isArray(window.CURRENT_INGREDIENTS) ? window.CURRENT_INGREDIENTS : [];

    // ================== Utils ==================
    function pill(text, cls) {
      const s = document.createElement('span');
      s.className = 'pill ' + (cls || '');
      s.textContent = text;
      return s;
    }
    function get(url) {
      return fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => r.json());
    }
    function _normThai(s) { return (s || '').toLocaleLowerCase('th-TH').trim(); }
    function isRelatedQuery(query, dish) {
      const q = _normThai(query).replace(/\s+/g, '');
      const d = _normThai(dish).replace(/\s+/g, '');
      if (!q || !d) return false;
      if (q.length >= 2 && (d.includes(q) || q.includes(d))) return true;
      const qw = _normThai(query).split(/\s+/).filter(w => w.length >= 2);
      const dw = _normThai(dish).split(/\s+/).filter(w => w.length >= 2);
      return qw.some(w => dw.includes(w));
    }
    function showNotFound() {
      document.getElementById('daily').style.display = 'none';
      const panel = document.getElementById('result');
      panel.style.display = 'block';
      document.getElementById('dish').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ';
      document.getElementById('all').innerHTML = '';
      document.getElementById('have').innerHTML = '';
      document.getElementById('missing').innerHTML = '';
    }

    // ================== Voice ==================
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening = false;
    function setStatus(t) { document.getElementById('voiceStatus').textContent = t || ''; }
    function ensureRec() {
      if (!SpeechRecognition) { alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á'); return null; }
      if (!rec) {
        rec = new SpeechRecognition();
        rec.lang = 'th-TH'; rec.interimResults = false; rec.continuous = false;
        rec.onstart = () => { listening = true; setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‚Ä¶'); };
        rec.onend = () => { listening = false; setStatus(''); };
        rec.onresult = (ev) => {
          const text = (ev.results?.[0]?.[0]?.transcript || '').trim();
          let q = text.toLocaleLowerCase('th-TH').replace(/^(‡πÄ‡∏°‡∏ô‡∏π|‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥|‡∏ó‡∏≥|‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏¥‡∏ô)\s*/, '').trim();
          if (!q) q = text;
          const qEl = document.getElementById('q');
          qEl.value = q;
          run(q);
        };
      }
      return rec;
    }

    document.getElementById('mic').addEventListener('click', () => {
      const r = ensureRec(); if (!r) return;
      if (listening) r.stop(); else { try { r.start(); } catch (e) { } }
    });

    // ================== Search Flow ==================
    async function run(q) {
      if (!q) {
        document.getElementById('daily').style.display = 'block';
        document.getElementById('result').style.display = 'none';
        return;
      }

      document.getElementById('daily').style.display = 'none';

      const data = await get(`{% url 'api_recipe_suggest' %}?q=${encodeURIComponent(q)}`);

      if (!data.ok) return showNotFound();
      if (!isRelatedQuery(q, data.dish)) return showNotFound();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      const result = document.getElementById('result');
      result.style.display = 'block';

      const dishH = document.getElementById('dish');
      dishH.textContent = data.dish;

      // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à source (‡πÄ‡∏î‡∏≤‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤ backend ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á)
      const src = data.source
        ? String(data.source).toLowerCase()
        : (Array.isArray(data.steps) && data.steps.length ? 'local' : 'api');

      // ‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥"
      const btn = document.createElement('button');
      btn.textContent = '‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥';
      btn.style.marginLeft = '8px';
      btn.addEventListener('click', () => openHowtoSmart(data.dish, src));
      dishH.appendChild(btn);

      // Pills
      const allBox = document.getElementById('all'); allBox.innerHTML = '';
      const haveBox = document.getElementById('have'); haveBox.innerHTML = '';
      const missBox = document.getElementById('missing'); missBox.innerHTML = '';

      (data.ingredients || []).forEach(x => allBox.appendChild(pill(x)));
      (data.have || []).forEach(x => haveBox.appendChild(pill(x, 'have')));
      (data.missing || []).forEach(x => missBox.appendChild(pill(x, 'missing')));
    }

    document.getElementById('go').addEventListener('click', () => {
      run(document.getElementById('q').value.trim());
    });
    const qInput = document.getElementById('q');
    qInput.addEventListener('keydown', e => { if (e.key === 'Enter') run(e.target.value.trim()); });
    qInput.addEventListener('input', () => {
      const v = qInput.value.trim();
      document.getElementById('result').style.display = v ? 'block' : 'none';
      document.getElementById('daily').style.display = v ? 'none' : 'block';
      if (!v) { document.getElementById('result').style.display = 'none'; }
    });

    // ================== Daily Recommendations ==================
    async function loadDailyRecs() {
      const wrapApi = document.getElementById('dailyGridApi');
      const wrapLocal = document.getElementById('dailyGridLocal');
      wrapApi.innerHTML = "";
      wrapLocal.innerHTML = "";

      const makeCard = (it) => {
        const card = document.createElement('div');
        card.className = "rec-card";
        card.style.cssText = "background:#fff;border:1px solid #e6f0ff;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.04)";

        if (it.image) {
          const img = document.createElement('img');
          img.src = it.image;
          img.alt = it.title || '';
          img.style.width = '100%';
          img.style.height = '140px';
          img.style.objectFit = 'cover';
          card.appendChild(img);
        }

        const body = document.createElement('div');
        body.style.padding = '10px 12px';

        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.style.marginBottom = '6px';
        title.textContent = it.title || '';
        body.appendChild(title);

        const usedLine = document.createElement('div');
        usedLine.style.fontSize = '12px';
        usedLine.style.marginTop = '6px';
        usedLine.textContent = '‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ: ';
        (it.used || []).forEach(x => usedLine.appendChild(pill(x, 'have')));
        if (!(it.used || []).length) usedLine.append(' -');
        body.appendChild(usedLine);

        const missLine = document.createElement('div');
        missLine.style.fontSize = '12px';
        missLine.style.marginTop = '6px';
        missLine.textContent = '‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î: ';
        (it.missing || []).forEach(x => missLine.appendChild(pill(x, 'missing')));
        if (!(it.missing || []).length) missLine.append(' -');
        body.appendChild(missLine);

        const btnRow = document.createElement('div');
        btnRow.style.cssText = 'margin-top:10px;display:flex;gap:8px;';
        const btn = document.createElement('button');
        btn.textContent = '‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥';
        btn.addEventListener('click', () => {
          const src = (String(it.source || (it.steps && it.steps.length ? 'local' : 'api'))).toLowerCase();
          openHowtoSmart(it.title || '', src);
        });
        btnRow.appendChild(btn);
        body.appendChild(btnRow);

        card.appendChild(body);
        return card;
      };

      // 1) ‡∏à‡∏≤‡∏Å API
      try {
        const res = await fetch("{% url 'api_daily_recs' %}", { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const items = await res.json();
        const isApi = (obj) => (String(obj.source || '').toLowerCase() === 'api') || !(Array.isArray(obj.steps) && obj.steps.length);
        const apiItems = (items || []).filter(isApi).slice(0, 3);
        if (!apiItems.length) {
          const msg = document.createElement('div');
          msg.style.gridColumn = '1/-1'; msg.style.color = '#64748b';
          msg.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å API';
          wrapApi.appendChild(msg);
        } else {
          apiItems.forEach(it => { it.source = 'api'; wrapApi.appendChild(makeCard(it)); });
        }
      } catch (e) {
        const msg = document.createElement('div');
        msg.style.gridColumn = '1/-1'; msg.style.color = '#C62828';
        msg.textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        wrapApi.appendChild(msg);
        console.warn('daily recs API error:', e);
      }

      // 2) ‡∏à‡∏≤‡∏Å Local
      try {
        const rLocal = await fetch("{% url 'api_daily_recs_local' %}", { headers: { 'Accept': 'application/json' } });
        if (!rLocal.ok) throw new Error("HTTP " + rLocal.status);
        const itemsLocal = await rLocal.json();

        if (!(itemsLocal || []).length) {
          const msg = document.createElement('div');
          msg.style.gridColumn = '1/-1'; msg.style.color = '#64748b';
          msg.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å Local';
          wrapLocal.appendChild(msg);
        } else {
          itemsLocal.forEach(it => { it.source = 'local'; wrapLocal.appendChild(makeCard(it)); });
        }
      } catch (e) {
        const msg = document.createElement('div');
        msg.style.gridColumn = '1/-1'; msg.style.color = '#C62828';
        msg.textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å Local ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        wrapLocal.appendChild(msg);
        console.warn('daily recs LOCAL error:', e);
      }
    }
    document.addEventListener('DOMContentLoaded', loadDailyRecs);

    // ================== HOWTO Fetchers ==================
    async function fetchHowto(dishName) {
      const url = HOWTO_URL + "?q=" + encodeURIComponent(dishName);
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) {
        throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
      }
      return data; // shape: { ok, title, ingredients, steps, videos? }
    }

    function _normalizeName(s) {
      return (s || '').trim().toLocaleLowerCase('th-TH').replace(/\s+/g, ' ');
    }

    async function fetchHowtoFromStatic(dishName) {
      const res = await fetch(window.HOWTO_STATIC, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();
      const want = _normalizeName(dishName);

      let root = data;
      if (root && typeof root === 'object' && !Array.isArray(root) &&
        root.recipes && typeof root.recipes === 'object') {
        root = root.recipes;
      }

      let found = null;

      if (root && typeof root === 'object' && !Array.isArray(root)) {
        for (const k of Object.keys(root)) {
          if (_normalizeName(k) === want) { found = root[k]; break; }
        }
        if (!found) {
          for (const v of Object.values(root)) {
            const t = _normalizeName(v?.title || v?.name || '');
            if (t === want) { found = v; break; }
          }
        }
      }
      if (!found && Array.isArray(root)) {
        found = root.find(x => _normalizeName(x.title || x.name) === want) || null;
      }
      if (!found && root && Array.isArray(root.items)) {
        found = root.items.find(x => _normalizeName(x.title || x.name) === want) || null;
      }

      if (!found) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');

      return {
        title: found.title || found.name || dishName,
        ingredients: Array.isArray(found.ingredients) ? found.ingredients : [],
        steps: Array.isArray(found.steps) ? found.steps : [],
        videos: Array.isArray(found.videos) ? found.videos : []
      };
    }

    // ================== HOWTO Modal + Render ==================
    function buildYTHowtoLink(dishName) {
      const kw = (dishName || '').trim().replace(/\s+/g, ' ');
      return 'https://www.youtube.com/results?search_query=' + encodeURIComponent(`${kw} ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥`);
    }

    function renderHowtoModal(data, fallbackDishName) {
      const titleEl = document.getElementById('howtoTitle');
      const ingEl = document.getElementById('howtoIngredients');
      const stepsWrap = document.getElementById('howtoSteps');
      const links = document.getElementById('howtoLinks');

      const dish = data.title || fallbackDishName || '';
      titleEl.textContent = dish;

      ingEl.textContent = Array.isArray(data.ingredients) && data.ingredients.length
        ? '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö: ' + data.ingredients.join(', ')
        : '';

      stepsWrap.innerHTML = '';
      const steps = Array.isArray(data.steps) ? data.steps : [];
      if (steps.length) {
        steps.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          stepsWrap.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
        stepsWrap.appendChild(li);
      }

      links.innerHTML = '';
      const ytBtn = document.createElement('a');
      ytBtn.href = buildYTHowtoLink(dish);
      ytBtn.target = '_blank';
      ytBtn.rel = 'noopener';
      ytBtn.className = 'btn-primary';
      ytBtn.style.display = 'inline-block';
      ytBtn.style.marginTop = '8px';
      ytBtn.textContent = '‡πÑ‡∏õ‡∏î‡∏π‡∏ö‡∏ô YouTube';
      links.appendChild(ytBtn);

      document.getElementById('howtoModal').style.display = 'flex';
    }

    async function openHowtoSmart(dishName, source) {
      const s = (source || '').toLowerCase();

      // policy: ‡∏ñ‡πâ‡∏≤ source = api ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î YouTube ‡∏ï‡∏£‡∏á ‡πÜ ‡∏Å‡πá‡πÑ‡∏î‡πâ
      if (s === 'api') {
        return renderHowtoModal({ title: dishName, steps: [] }, dishName); // ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏õ YouTube ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏•
      }

      // 1) ‡∏•‡∏≠‡∏á API ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
      try {
        const data = await fetchHowto(dishName);
        return renderHowtoModal(data, dishName);
      } catch (_) { }

      // 2) ‡∏•‡∏≠‡∏á Static ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      try {
        const data = await fetchHowtoFromStatic(dishName);
        return renderHowtoModal(data, dishName);
      } catch (_) { }

      // 3) ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Üí ‡πÉ‡∏´‡πâ‡πÇ‡∏°‡∏î‡∏±‡∏•‡∏ß‡πà‡∏≤‡∏á + ‡∏õ‡∏∏‡πà‡∏° YouTube
      return renderHowtoModal({ title: dishName, steps: [] }, dishName);
    }

    window.openHowtoSmart = openHowtoSmart; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å card

    // ================== Modal Controls ==================
    function closeHowto() {
      document.getElementById('howtoModal').style.display = 'none';
      stopSpeak();
    }
    document.getElementById('btnClose').addEventListener('click', closeHowto);
    document.getElementById('howtoModal').addEventListener('click', (e) => {
      if (e.target.id === 'howtoModal') closeHowto();
    });

    // ================== Thai TTS (‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á) ==================
    let _ttsQueue = [];
    let _ttsSpeaking = false;
    let _thaiVoice = null;

    function pickThaiVoice() {
      const list = speechSynthesis.getVoices() || [];
      _thaiVoice = list.find(v => /th(-|_)?TH/i.test(v.lang)) ||
        list.find(v => /Thai|‡πÑ‡∏ó‡∏¢/i.test(v.name)) || null;
    }

    function speakHowto() {
      if (!('speechSynthesis' in window)) { alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î'); return; }
      stopSpeak();

      if (!_thaiVoice) {
        if (speechSynthesis.onvoiceschanged === null) {
          speechSynthesis.onvoiceschanged = () => {
            pickThaiVoice();
            speechSynthesis.onvoiceschanged = null;
            speakHowto();
          };
        }
        pickThaiVoice();
      }

      const title = document.getElementById('howtoTitle')?.textContent || '';
      const ingText = document.getElementById('howtoIngredients')?.textContent || '';
      const steps = Array.from(document.querySelectorAll('#howtoSteps li')).map(li => li.textContent);

      const parts = [];
      if (title) parts.push(`‡πÄ‡∏°‡∏ô‡∏π: ${title}`);
      if (ingText) parts.push(ingText);
      if (steps.length) {
        parts.push('‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥:');
        steps.forEach((s, i) => parts.push(`‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${i + 1} ${s}`));
      }

      _ttsQueue = parts.map(t => {
        const u = new SpeechSynthesisUtterance(t);
        u.lang = 'th-TH';
        if (_thaiVoice) u.voice = _thaiVoice;
        u.rate = 1.0;
        return u;
      });

      _ttsSpeaking = true;
      speakNext();
    }

    function speakNext() {
      if (!_ttsSpeaking || _ttsQueue.length === 0) { _ttsSpeaking = false; return; }
      const u = _ttsQueue.shift();
      u.onend = () => speakNext();
      u.onerror = () => speakNext();
      speechSynthesis.speak(u);
    }

    function stopSpeak() {
      if (!('speechSynthesis' in window)) return;
      _ttsSpeaking = false;
      _ttsQueue = [];
      speechSynthesis.cancel();
    }

    document.getElementById('btnSpeak').addEventListener('click', speakHowto);
  </script>
</body>

</html>